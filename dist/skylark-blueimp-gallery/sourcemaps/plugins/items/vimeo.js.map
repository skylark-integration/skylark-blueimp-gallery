{"version":3,"sources":["plugins/items/vimeo.js"],"names":["define","langx","noder","$","Gallery","video","VimeoPlayer","Evented","inherit","klassName","init","url","videoId","playerId","clickToPlay","this","element","document","createElement","listeners","canPlayType","on","type","func","loadAPI","scriptTag","called","that","apiUrl","scriptTags","getElementsByTagName","i","length","callback","playOnReady","play","src","parentNode","insertBefore","test","readyState","onReady","ready","player","addEvent","hasPlayed","onPlaying","onPause","playStatus","playing","pause","insertIframe","iframe","replace","id","replaceChild","window","navigator","platform","api","$f","counter","VimeoItemFactory","ctor","options","vimeoVideoIdProperty","vimeoPlayerUrl","vimeoPlayerIdPrefix","vimeoClickToPlay","initOptions","overrided","mixin","prototype","render","obj","getItemProperty","undefined","urlProperty","pluginInfo","name","mimeType","installPlugin"],"mappings":";;;;;;;AAAAA,QACE,sBACA,0BACA,0BACA,gBACA,WACC,SAAUC,EAAOC,EAAOC,EAAGC,EAASC,GACrC,aAEA,IAAIC,EAAcL,EAAMM,QAAQC,SAC9BC,UAAW,cAEXC,KAAM,SAAUC,EAAKC,EAASC,EAAUC,GACtCC,KAAKJ,IAAMA,EACXI,KAAKH,QAAUA,EACfG,KAAKF,SAAWA,EAChBE,KAAKD,YAAcA,EACnBC,KAAKC,QAAUC,SAASC,cAAc,OACtCH,KAAKI,cAGPC,YAAa,WACX,OAAO,GAGTC,GAAI,SAAUC,EAAMC,GAElB,OADAR,KAAKI,UAAUG,GAAQC,EAChBR,MAGTS,QAAS,WACP,IAIIC,EACAC,EALAC,EAAOZ,KACPa,EAAS,yCACTC,EAAaZ,SAASa,qBAAqB,UAC3CC,EAAIF,EAAWG,OAInB,SAASC,KACFP,GAAUC,EAAKO,aAClBP,EAAKQ,OAEPT,GAAS,EAEX,KAAOK,GAEL,GAAIF,EADJE,GAAK,GACaK,MAAQR,EAAQ,CAChCH,EAAYI,EAAWE,GACvB,MAGCN,KACHA,EAAYR,SAASC,cAAc,WACzBkB,IAAMR,GAElBzB,EAAEsB,GAAWJ,GAAG,OAAQY,GACxBJ,EAAW,GAAGQ,WAAWC,aAAab,EAAWI,EAAW,IAExD,kBAAkBU,KAAKd,EAAUe,aACnCP,KAIJQ,QAAS,WACP,IAAId,EAAOZ,KACXA,KAAK2B,OAAQ,EACb3B,KAAK4B,OAAOC,SAAS,OAAQ,WAC3BjB,EAAKkB,WAAY,EACjBlB,EAAKmB,cAEP/B,KAAK4B,OAAOC,SAAS,QAAS,WAC5BjB,EAAKoB,YAEPhC,KAAK4B,OAAOC,SAAS,SAAU,WAC7BjB,EAAKoB,YAEHhC,KAAKmB,aACPnB,KAAKoB,QAITW,UAAW,WACL/B,KAAKiC,WAAa,IACpBjC,KAAKI,UAAU8B,UACflC,KAAKiC,WAAa,IAItBD,QAAS,WACPhC,KAAKI,UAAU+B,eACRnC,KAAKiC,YAGdG,aAAc,WACZ,IAAIC,EAASnC,SAASC,cAAc,UACpCkC,EAAOhB,IAAMrB,KAAKJ,IACf0C,QAAQ,WAAYtC,KAAKH,SACzByC,QAAQ,YAAatC,KAAKF,UAC7BuC,EAAOE,GAAKvC,KAAKF,SACjBE,KAAKC,QAAQqB,WAAWkB,aAAaH,EAAQrC,KAAKC,SAClDD,KAAKC,QAAUoC,GAGjBjB,KAAM,WACJ,IAAIR,EAAOZ,KACNA,KAAKiC,aACRjC,KAAKI,UAAUgB,OACfpB,KAAKiC,WAAa,GAEhBjC,KAAK2B,OAEJ3B,KAAK8B,YACL9B,KAAKD,aACH0C,OAAOC,WACN,iBAAiBlB,KAAKiB,OAAOC,UAAUC,WAM3C3C,KAAK+B,YAEL/B,KAAK4B,OAAOgB,IAAI,SAGlB5C,KAAKmB,aAAc,EACdsB,OAAOI,GAEA7C,KAAK4B,SACf5B,KAAKoC,eACLpC,KAAK4B,OAASiB,GAAG7C,KAAKC,SACtBD,KAAK4B,OAAOC,SAAS,QAAS,WAC5BjB,EAAKc,aALP1B,KAAKS,YAWX0B,MAAO,WACDnC,KAAK2B,MACP3B,KAAK4B,OAAOgB,IAAI,SACP5C,KAAKiC,oBACPjC,KAAKmB,YACZnB,KAAKI,UAAU+B,eACRnC,KAAKiC,eAMda,EAAU,EAEVC,EAAmBzD,EAAM0D,KAAKvD,SAChCC,UAAW,mBAEXH,YAAaA,EAEb0D,SAEEC,qBAAsB,QAGtBC,eAAgB,8DAEhBC,oBAAqB,gBAErBC,kBAAkB,GAGpBC,YAAa,SAAUL,GACrBjD,KAAKuD,YACLvD,KAAKiD,QAAU/D,EAAMsE,MAAMxD,KAAKiD,QAASF,EAAiBU,UAAUR,QAASA,IAG/ES,OAAQ,SAAUC,EAAKzC,GACrB,IAAI+B,EAAUjD,KAAKiD,QACfpD,EAAUG,KAAK4D,gBAAgBD,EAAKV,EAAQC,sBAChD,GAAIrD,EAKF,YAJuDgE,IAAnD7D,KAAK4D,gBAAgBD,EAAKV,EAAQa,eACpCH,EAAIV,EAAQa,aAAe,eAAiBjE,GAE9CiD,GAAW,EACJ9C,KAAKuD,UACVI,EACAzC,EACA,IAAI3B,EACF0D,EAAQE,eACRtD,EACAoD,EAAQG,oBAAsBN,EAC9BG,EAAQI,sBAOdU,GACFC,KAAM,QACNC,SAAU,QACVjB,KAAMD,GAKR,OAFA1D,EAAQ6E,cAAc,QAASH,GAExBA","file":"../../../plugins/items/vimeo.js","sourcesContent":["define([\r\n  \"skylark-langx/langx\",\r\n  \"skylark-utils-dom/noder\",\r\n  \"skylark-utils-dom/query\",\r\n  '../../Gallery',\r\n  './video'\r\n], function (langx, noder, $, Gallery, video) {\r\n  'use strict'\r\n\r\n  var VimeoPlayer = langx.Evented.inherit({\r\n    klassName: \"VimeoPlayer\",\r\n\r\n    init: function (url, videoId, playerId, clickToPlay) {\r\n      this.url = url\r\n      this.videoId = videoId\r\n      this.playerId = playerId\r\n      this.clickToPlay = clickToPlay\r\n      this.element = document.createElement('div')\r\n      this.listeners = {}\r\n    },\r\n\r\n    canPlayType: function () {\r\n      return true\r\n    },\r\n\r\n    on: function (type, func) {\r\n      this.listeners[type] = func\r\n      return this\r\n    },\r\n\r\n    loadAPI: function () {\r\n      var that = this\r\n      var apiUrl = '//f.vimeocdn.com/js/froogaloop2.min.js'\r\n      var scriptTags = document.getElementsByTagName('script')\r\n      var i = scriptTags.length\r\n      var scriptTag\r\n      var called\r\n\r\n      function callback() {\r\n        if (!called && that.playOnReady) {\r\n          that.play()\r\n        }\r\n        called = true\r\n      }\r\n      while (i) {\r\n        i -= 1\r\n        if (scriptTags[i].src === apiUrl) {\r\n          scriptTag = scriptTags[i]\r\n          break\r\n        }\r\n      }\r\n      if (!scriptTag) {\r\n        scriptTag = document.createElement('script')\r\n        scriptTag.src = apiUrl\r\n      }\r\n      $(scriptTag).on('load', callback)\r\n      scriptTags[0].parentNode.insertBefore(scriptTag, scriptTags[0])\r\n      // Fix for cached scripts on IE 8:\r\n      if (/loaded|complete/.test(scriptTag.readyState)) {\r\n        callback()\r\n      }\r\n    },\r\n\r\n    onReady: function () {\r\n      var that = this\r\n      this.ready = true\r\n      this.player.addEvent('play', function () {\r\n        that.hasPlayed = true\r\n        that.onPlaying()\r\n      })\r\n      this.player.addEvent('pause', function () {\r\n        that.onPause()\r\n      })\r\n      this.player.addEvent('finish', function () {\r\n        that.onPause()\r\n      })\r\n      if (this.playOnReady) {\r\n        this.play()\r\n      }\r\n    },\r\n\r\n    onPlaying: function () {\r\n      if (this.playStatus < 2) {\r\n        this.listeners.playing()\r\n        this.playStatus = 2\r\n      }\r\n    },\r\n\r\n    onPause: function () {\r\n      this.listeners.pause()\r\n      delete this.playStatus\r\n    },\r\n\r\n    insertIframe: function () {\r\n      var iframe = document.createElement('iframe')\r\n      iframe.src = this.url\r\n        .replace('VIDEO_ID', this.videoId)\r\n        .replace('PLAYER_ID', this.playerId)\r\n      iframe.id = this.playerId\r\n      this.element.parentNode.replaceChild(iframe, this.element)\r\n      this.element = iframe\r\n    },\r\n\r\n    play: function () {\r\n      var that = this\r\n      if (!this.playStatus) {\r\n        this.listeners.play()\r\n        this.playStatus = 1\r\n      }\r\n      if (this.ready) {\r\n        if (\r\n          !this.hasPlayed &&\r\n          (this.clickToPlay ||\r\n            (window.navigator &&\r\n              /iP(hone|od|ad)/.test(window.navigator.platform)))\r\n        ) {\r\n          // Manually trigger the playing callback if clickToPlay\r\n          // is enabled and to workaround a limitation in iOS,\r\n          // which requires synchronous user interaction to start\r\n          // the video playback:\r\n          this.onPlaying()\r\n        } else {\r\n          this.player.api('play')\r\n        }\r\n      } else {\r\n        this.playOnReady = true\r\n        if (!window.$f) {\r\n          this.loadAPI()\r\n        } else if (!this.player) {\r\n          this.insertIframe()\r\n          this.player = $f(this.element)\r\n          this.player.addEvent('ready', function () {\r\n            that.onReady()\r\n          })\r\n        }\r\n      }\r\n    },\r\n\r\n    pause: function () {\r\n      if (this.ready) {\r\n        this.player.api('pause');\r\n      } else if (this.playStatus) {\r\n        delete this.playOnReady;\r\n        this.listeners.pause()\r\n        delete this.playStatus;\r\n      }\r\n    }\r\n  });\r\n\r\n\r\n  var counter = 0;\r\n\r\n  var VimeoItemFactory = video.ctor.inherit({\r\n    klassName: \"VimeoItemFactory\",\r\n\r\n    VimeoPlayer: VimeoPlayer,\r\n\r\n    options: {\r\n      // The list object property (or data attribute) with the Vimeo video id:\r\n      vimeoVideoIdProperty: 'vimeo',\r\n      // The URL for the Vimeo video player, can be extended with custom parameters:\r\n      // https://developer.vimeo.com/player/embedding\r\n      vimeoPlayerUrl: '//player.vimeo.com/video/VIDEO_ID?api=1&player_id=PLAYER_ID',\r\n      // The prefix for the Vimeo video player ID:\r\n      vimeoPlayerIdPrefix: 'vimeo-player-',\r\n      // Require a click on the native Vimeo player for the initial playback:\r\n      vimeoClickToPlay: true\r\n    },\r\n\r\n    initOptions: function (options) {\r\n      this.overrided();\r\n      this.options = langx.mixin(this.options, VimeoItemFactory.prototype.options, options);\r\n    },\r\n\r\n    render: function (obj, callback) {\r\n      var options = this.options\r\n      var videoId = this.getItemProperty(obj, options.vimeoVideoIdProperty)\r\n      if (videoId) {\r\n        if (this.getItemProperty(obj, options.urlProperty) === undefined) {\r\n          obj[options.urlProperty] = '//vimeo.com/' + videoId\r\n        }\r\n        counter += 1;\r\n        return this.overrided(\r\n          obj,\r\n          callback,\r\n          new VimeoPlayer(\r\n            options.vimeoPlayerUrl,\r\n            videoId,\r\n            options.vimeoPlayerIdPrefix + counter,\r\n            options.vimeoClickToPlay\r\n          )\r\n        )\r\n      }\r\n    }\r\n  });\r\n\r\n  var pluginInfo = {\r\n    name: \"vimeo\",\r\n    mimeType: \"vimeo\",\r\n    ctor: VimeoItemFactory\r\n  };\r\n\r\n  Gallery.installPlugin(\"items\", pluginInfo);\r\n\r\n  return pluginInfo;\r\n\r\n});"]}